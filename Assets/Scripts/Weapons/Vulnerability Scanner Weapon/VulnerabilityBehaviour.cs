using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class VulnerabilityBehaviour : InstantWeaponBehaviour
{
    private BoxCollider2D beamCollider;
    private SpriteRenderer beamRenderer;
    private float beamLength = 1000f; // Length of the beam

    private bool hasHit = false; // To ensure we only hit once per target

    protected override void Awake()
    {
        base.Awake();
        beamCollider = GetComponent<BoxCollider2D>();
        beamRenderer = GetComponent<SpriteRenderer>();

        if (beamCollider != null)
            beamCollider.isTrigger = true;
    }

    protected override void Start()
    {
        base.Start();
    }

    /// <summary>
    /// Setup the beam's direction, damage, and duration
    /// </summary>
    public void Setup(Vector3 dir, WeaponScriptableObject weaponData)
    {
        this.weaponData = weaponData;

        currentDamage = weaponData.Damage * FindObjectOfType<PlayerStats>().CurrentMight;
        destroyAfterSeconds = weaponData.Speed; // Using Speed as duration for beam

        Vector3 direction = dir.normalized;

        // Rotation to face the direction
        float angle = Mathf.Atan2(direction.y, direction.x) * Mathf.Rad2Deg;
        transform.rotation = Quaternion.Euler(0f, 0f, angle);

        // Adjust the beam's length and scale
        float originalWidth = beamRenderer.sprite.bounds.size.x;
        Vector3 newScale = transform.localScale;
        newScale.x = beamLength / originalWidth;
        transform.localScale = newScale;

        // Adjust collider size
        if (beamCollider != null)
        {
            beamCollider.size = new Vector2(1, beamCollider.size.y);
            beamCollider.offset = new Vector2(0.5f, 0);
        }
    }

    private HashSet<Collider2D> hitTargets = new HashSet<Collider2D>();

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (hitTargets.Contains(other)) return;

        if (other.CompareTag("Enemy"))
        {
            if (other.TryGetComponent(out EnemyStats enemy))
            {
                enemy.TakeDamage(currentDamage);
                hitTargets.Add(other);
            }
        }
        else if (other.CompareTag("Prop"))
        {
            if (other.TryGetComponent(out BreakableProps prop))
            {
                prop.TakeDamage(currentDamage);
                hitTargets.Add(other);
            }
        }
    }


    protected override void ApplyEffect()
    {
        // Beam effect is applied on trigger enter, so nothing needed here
    }
}
